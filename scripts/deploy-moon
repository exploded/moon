#!/bin/bash
# /usr/local/bin/deploy-moon
# Runs as root (via sudo) during GitHub Actions deployments.
#
# To update this script on the server, include scripts/deploy-moon in the SCP
# bundle — it will self-update and re-exec before doing anything else.

set -e

DEPLOY_SRC="${1:-/tmp/moon-deploy}"
DEPLOY_DIR=/var/www/moon

# Self-update: if the bundle contains a newer version of this script, install
# it and re-exec so the rest of the deployment runs with the updated logic.
BUNDLE_SCRIPT="$DEPLOY_SRC/scripts/deploy-moon"
if [ -f "$BUNDLE_SCRIPT" ] && ! diff -q /usr/local/bin/deploy-moon "$BUNDLE_SCRIPT" > /dev/null 2>&1; then
    echo "[deploy] Updating deploy script from bundle..."
    install -m 755 "$BUNDLE_SCRIPT" /usr/local/bin/deploy-moon
    exec /usr/local/bin/deploy-moon "$@"
fi

# Read the service owner from the installed unit — no hardcoded username
SERVICE_USER=$(systemctl show moon --property=User --value)
SERVICE_GROUP=$(systemctl show moon --property=Group --value)

if [ -z "$SERVICE_USER" ]; then
    echo "[deploy] ERROR: Could not read User from moon.service"
    exit 1
fi

echo "[deploy] Stopping service..."
systemctl stop moon || true

echo "[deploy] Installing binary to $DEPLOY_DIR/moon (owner: $SERVICE_USER:$SERVICE_GROUP)..."
rm -f "$DEPLOY_DIR/moon"
cp "$DEPLOY_SRC/moon" "$DEPLOY_DIR/moon"
chmod +x "$DEPLOY_DIR/moon"

echo "[deploy] Updating web assets..."
cp "$DEPLOY_SRC/index.html"    "$DEPLOY_DIR/"
cp "$DEPLOY_SRC/about.html"    "$DEPLOY_DIR/"
cp "$DEPLOY_SRC/calendar.html" "$DEPLOY_DIR/"
cp -r "$DEPLOY_SRC/static/"    "$DEPLOY_DIR/"
chown -R "$SERVICE_USER:$SERVICE_GROUP" "$DEPLOY_DIR"

echo "[deploy] Starting service..."
systemctl start moon

echo "[deploy] Verifying service is active..."
sleep 2
if ! systemctl is-active --quiet moon; then
    echo "[deploy] ERROR: Service failed to start. Status:"
    systemctl status moon --no-pager --lines=30
    exit 1
fi

echo "[deploy] Cleaning up..."
rm -rf "$DEPLOY_SRC"

echo "[deploy] Done — moon is running."
